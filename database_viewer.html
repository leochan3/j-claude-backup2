<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobSpy Database Viewer</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .stat-card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-number { 
            font-size: 2em; 
            font-weight: bold; 
            color: #007bff; 
        }
        .stat-label { 
            color: #666; 
            margin-top: 5px;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .loading { color: #007bff; text-align: center; padding: 20px; }
        .error { color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 5px; }
        .job-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .job-title { font-weight: bold; color: #007bff; font-size: 1.1em; }
        .job-company { color: #28a745; font-weight: bold; }
        .job-location { color: #6c757d; }
        .job-meta { font-size: 0.9em; color: #666; margin-top: 10px; }
        .company-card { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px;
            border-left: 4px solid #2196f3;
        }
        .search-form { 
            display: grid; 
            grid-template-columns: 1fr 1fr auto; 
            gap: 10px; 
            margin-bottom: 20px;
            align-items: end;
        }
        input { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        .top-companies { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è JobSpy Database Viewer</h1>
        
        <div class="stats-grid" id="statsGrid">
            <div class="loading">üìä Loading database statistics...</div>
        </div>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="loadStats()">üîÑ Refresh Stats</button>
            <button onclick="loadCompanies()">üè¢ View Companies</button>
            <button onclick="showSearchForm()">üîç Search Jobs</button>
        </div>
    </div>

    <div class="container" id="companiesSection" style="display: none;">
        <h2>üè¢ Target Companies</h2>
        <div id="companiesList">
            <div class="loading">Loading companies...</div>
        </div>
    </div>

    <div class="container" id="searchSection" style="display: none;">
        <h2>üîç Search Jobs</h2>
        <div class="search-form">
            <input type="text" id="searchTerm" placeholder="Search term (e.g., software engineer)">
            <input type="text" id="companyName" placeholder="Company name (optional)">
            <button onclick="searchJobs()">Search</button>
        </div>
        <div id="searchResults"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        async function loadStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '<div class="loading">üìä Loading database statistics...</div>';

            try {
                const response = await fetch(`${API_BASE}/database-stats-public`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const stats = data.stats;

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_jobs.toLocaleString()}</div>
                        <div class="stat-label">Total Jobs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.jobs_last_30_days.toLocaleString()}</div>
                        <div class="stat-label">Jobs (Last 30 Days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_companies}</div>
                        <div class="stat-label">Target Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.successful_runs}</div>
                        <div class="stat-label">Scraping Runs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.success_rate}%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                `;

                // Show top companies
                if (stats.top_companies && stats.top_companies.length > 0) {
                    const topCompaniesHtml = stats.top_companies.map(company => `
                        <div class="company-card">
                            <strong>${company.company}</strong>
                            <span style="float: right;">${company.job_count} jobs</span>
                        </div>
                    `).join('');

                    statsGrid.innerHTML += `
                        <div style="grid-column: 1 / -1;">
                            <h3>üèÜ Top Companies by Job Count</h3>
                            <div class="top-companies">
                                ${topCompaniesHtml}
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                statsGrid.innerHTML = `
                    <div class="error">
                        ‚ùå Error loading stats: ${error.message}
                        <br><br>
                        Make sure the server is running: <code>python backend/main.py</code>
                    </div>
                `;
            }
        }

        async function loadCompanies() {
            const section = document.getElementById('companiesSection');
            const list = document.getElementById('companiesList');
            
            section.style.display = 'block';
            list.innerHTML = '<div class="loading">Loading companies...</div>';

            try {
                const response = await fetch(`${API_BASE}/target-companies-public`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data.companies && data.companies.length > 0) {
                    list.innerHTML = data.companies.map(company => `
                        <div class="company-card">
                            <strong>${company.display_name || company.name}</strong>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                                <div>üìç Locations: ${company.location_filters.join(', ')}</div>
                                <div>üîç Search Terms: ${company.search_terms.join(', ')}</div>
                                <div>üåê Sites: ${company.preferred_sites.join(', ')}</div>
                                <div>üìä Total Jobs: ${company.total_jobs_found}</div>
                                <div>üïí Last Scraped: ${company.last_scraped ? new Date(company.last_scraped).toLocaleString() : 'Never'}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="error">No companies found. Run setup_job_database.py to add companies.</div>';
                }

            } catch (error) {
                list.innerHTML = `<div class="error">‚ùå Error loading companies: ${error.message}</div>`;
            }
        }

        function showSearchForm() {
            document.getElementById('searchSection').style.display = 'block';
        }

        async function searchJobs() {
            const searchTerm = document.getElementById('searchTerm').value;
            const companyName = document.getElementById('companyName').value;
            const resultsDiv = document.getElementById('searchResults');

            resultsDiv.innerHTML = '<div class="loading">üîç Searching jobs...</div>';

            const searchData = {
                search_term: searchTerm || undefined,
                company_names: companyName ? [companyName] : undefined,
                days_old: 30,
                limit: 20
            };

            try {
                const response = await fetch(`${API_BASE}/search-jobs-local-public`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(searchData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.jobs && data.jobs.length > 0) {
                    resultsDiv.innerHTML = `
                        <h3>üìä Found ${data.total_count} jobs (showing ${data.jobs.length})</h3>
                        ${data.jobs.map(job => `
                            <div class="job-card">
                                <div class="job-title">${job.title}</div>
                                <div class="job-company">üè¢ ${job.company}</div>
                                <div class="job-location">üìç ${job.location || 'Location not specified'}</div>
                                ${job.min_amount || job.max_amount ? `
                                    <div style="color: #28a745; font-weight: bold;">
                                        üí∞ ${job.min_amount ? '$' + job.min_amount.toLocaleString() : ''}
                                        ${job.min_amount && job.max_amount ? ' - ' : ''}
                                        ${job.max_amount ? '$' + job.max_amount.toLocaleString() : ''}
                                        ${job.salary_interval ? ' / ' + job.salary_interval : ''}
                                    </div>
                                ` : ''}
                                <div class="job-meta">
                                    üåê ${job.site} | 
                                    üìÖ Posted: ${job.date_posted ? new Date(job.date_posted).toLocaleDateString() : 'Unknown'} | 
                                    üîç Scraped: ${new Date(job.date_scraped).toLocaleDateString()}
                                    ${job.min_experience_years ? ` | üéØ ${job.min_experience_years}+ years exp` : ''}
                                    ${job.is_remote ? ' | üè† Remote' : ''}
                                </div>
                                ${job.job_url ? `<div style="margin-top: 10px;"><a href="${job.job_url}" target="_blank">üîó View Job</a></div>` : ''}
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="error">No jobs found. Try different search terms or scrape more companies.</div>';
                }

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Search error: ${error.message}</div>`;
            }
        }

        // Load stats on page load
        loadStats();
    </script>
</body>
</html>